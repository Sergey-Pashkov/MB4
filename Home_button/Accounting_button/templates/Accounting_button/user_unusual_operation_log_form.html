{% extends "Accounting_button/base.html" %}
{% load widget_tweaks %}

{% block title %}{{ form.instance.pk|yesno:"Редактировать нестандартную операцию,Создать нестандартную операцию" }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title">{{ form.instance.pk|yesno:"Редактировать нестандартную операцию,Создать нестандартную операцию" }}</h3>
                </div>
                <div class="card-body">
                    <p>Добро пожаловать, {{ user.username }}!</p>
                    <form method="post">
                        {% csrf_token %}
                        <div class="form-group row">
                            <label for="{{ form.operation_content.id_for_label }}" class="col-sm-3 col-form-label">Содержание операции</label>
                            <div class="col-sm-9">
                                {{ form.operation_content|add_class:"form-control" }}
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="{{ form.duration_minutes.id_for_label }}" class="col-sm-3 col-form-label">Длительность (минуты)</label>
                            <div class="col-sm-9">
                                {{ form.duration_minutes|add_class:"form-control" }}
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="{{ form.client.id_for_label }}" class="col-sm-3 col-form-label">Клиент</label>
                            <div class="col-sm-9">
                                {{ form.client|add_class:"form-control" }}
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="{{ form.price_category.id_for_label }}" class="col-sm-3 col-form-label">Категория цены</label>
                            <div class="col-sm-9">
                                {{ form.price_category|add_class:"form-control" }}
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="operation_cost" class="col-sm-3 col-form-label">Стоимость операции</label>
                            <div class="col-sm-9">
                                <input type="text" id="operation_cost" class="form-control" readonly value="{{ form.instance.operation_cost }}">
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-sm-9 offset-sm-3">
                                <button type="submit" class="btn btn-primary">Сохранить</button>
                                <a href="{% url 'user_unusual_operation_log_list' %}" class="btn btn-secondary ml-2">Назад к списку</a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const priceCategoryField = document.querySelector('#id_price_category');
    const durationField = document.querySelector('#id_duration_minutes');
    const operationCostField = document.querySelector('#operation_cost');

    function updateOperationCost() {
        const priceCategory = priceCategoryField.value;
        const duration = parseFloat(durationField.value);
        
        if (isNaN(duration)) {
            operationCostField.value = 'Invalid duration';
            return;
        }

        let costPerMinute = 0;

        if (priceCategory === 'Главный бухгалтер') {
            costPerMinute = parseFloat('{{ chief_accountant_cost }}');
        } else if (priceCategory === 'Бухгалтер') {
            costPerMinute = parseFloat('{{ accountant_cost }}');
        }

        if (!isNaN(costPerMinute)) {
            operationCostField.value = (costPerMinute * duration).toFixed(2);
        } else {
            operationCostField.value = 'Cost not available';
        }
    }

    priceCategoryField.addEventListener('change', updateOperationCost);
    durationField.addEventListener('input', updateOperationCost);
    updateOperationCost();
});
</script>
{% endblock %}
